---
layout:       post
title:        "How to enable NCCL P2P for 4090 worksation"
author:       "Allan"
header-style: text
catalog:      true
mathjax:      true
comments: true
tags:
    - Nvidia
    - Driver
    - P2P
---
# Background
In multi card training, P2P communicatin is critical for training as loss value must be sync across all GPU, which make the speed of training is highly affected by the speed of card communication. 
However, as Nvidia cut the support of NCCL P2P communication for 4090. We need to find a way to override it. 

# Results to achieve
<img width="552" alt="image" src="https://github.com/user-attachments/assets/3c27b585-0bbe-4d82-8e49-946658019cbe" />
<img width="1194" alt="image" src="https://github.com/user-attachments/assets/86d90742-8fcb-4e43-b916-63bc71685872" />

# The Process to install a hacked driver that enable P2P
## Install driver
1. Uninstall all old nvidia driver via
```
sudo apt purge '^nvidia-.*'
sudo apt autoremove
sudo apt autoclean
```

2. reboot
   
3. unload nvidia_drm if exist via
```
systemctl isolate multi-user.target
modprobe -r nvidia-drm

# if all process completed but no GUI appear
systemctl start graphical.target
```

4. clone the [repo](https://github.com/tinygrad/open-gpu-kernel-modules/tree/565.57.01-p2p)
5. configure to correct branch via `git branch -a && git switch XXX.XX.XX`. In my case I use `git switch 565.57.01-p2p`
6. run `make modules -j$(nproc)`. If report gcc error, you need to install gcc-12 via
```
sudo apt update
sudo apt install gcc-12 g++-12
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 120 --slave /usr/bin/g++ g++ /usr/bin/g++-12
```

7. run `sudo make modules_install -j$(nproc)`
8. Download the correct verion of linux driver (e.g. `https://www.nvidia.com/en-us/drivers/details/233008/`) and install it via `sh ./NVIDIA-Linux-[...].run --no-kernel-modules`
9. reboot

# Enable/Check ReBar and stop iommu and/or amd_iommu
To check rebar activated or not, command can be done via `nvidia-smi -q | grep -i bar -A 3`. If Total >= 256MB, then rebar is activated. If not, please check BIOS and motherboard update so that to enable this function.
<img width="635" alt="image" src="https://github.com/user-attachments/assets/8f951980-498a-46ab-b5cd-a7b07ed6931e" />

To stop iommu or amd_iommu, we can go to BIOS to toggle it. Or we can tell grub and linux kernal, i.e. we can just simply use `sudo nano /etc/default/grub` and locate `GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"`. Then we modify to 
`GRUB_CMDLINE_LINUX_DEFAULT="quiet splash amd_iommu=off iommu=off"`

If failed to stop iommu and activate rebar, the p2p communication will not succeed.

# Install Cudatoolkit and compile SimpleP2P & P2PLatencyTest to validate the results
## Install cudatoolkit and configure path
To install Cudatoolkit, we need to go to [cudatoolkit download](https://developer.nvidia.com/cuda-downloads) to download it.
However, you still need to configue properly to let cuda to know your nvcc location, via
```
export PATH=/usr/local/cuda-12.9/bin:$PATH
```
in my case i use CUDA-12.9 toolkit, for different toolkit a correct path must be located first. 
else you will receive error of 
```
Command 'nvcc' not found
```

and gcc-12 location for nvcc, via 
```
 export CUDAHOSTCXX=/usr/bin/g++-12
```
else you will get error of 
```
gcc: fatal error: cannot execute ‘cc1plus’: execvp: No such file or directory
compilation terminated.
nvcc fatal   : Failed to preprocess host compiler properties.
```

## SimpleP2P 
This is some sample cuda code that use to determine whether p2p is activated

1. we need to clone a [repo](https://github.com/NVIDIA/cuda-samples) via `git clone https://github.com/NVIDIA/cuda-samples`
2. Then we can go to compile SimpleP2P and use it via
```
cd cuda-samples/Samples/0_Introduction/simpleP2P/
mkdir build && cd build
cmake ..
make -j$(nproc)
```
3. to use it, simply input `./simpleP2P` into cli

## P2PLatencyTest
1. Similiarly, we can compile P2PLatencyTest via
```
cd cuda-samples/Samples/5_Domain_Specific/p2pBandwidthLatencyTest/
mkdir build && cd build
cmake ..
make -j$(nproc)
```
2. to use it, simply input `./p2pBandwidthLatencyTest` into cli
