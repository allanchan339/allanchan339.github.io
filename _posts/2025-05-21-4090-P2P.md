---
layout:       post
title:        "How to enable NCCL P2P for 4090 worksation"
author:       "Allan"
header-style: text
catalog:      true
mathjax:      true
comments: true
tags:
    - Nvidia
    - Driver
    - P2P
---
# Background
In multi card training, P2P communicatin is critical for training as loss value must be sync across all GPU, which make the speed of training is highly affected by the speed of card communication. 
However, as Nvidia cut the support of NCCL P2P communication for 4090. We need to find a way to override it. 

# Results to achieve
<img width="552" alt="image" src="https://github.com/user-attachments/assets/3c27b585-0bbe-4d82-8e49-946658019cbe" />
<img width="1194" alt="image" src="https://github.com/user-attachments/assets/86d90742-8fcb-4e43-b916-63bc71685872" />

# The Process to install a hacked driver that enable P2P
1. Uninstall all old nvidia driver via
```
sudo apt purge '^nvidia-.*'
sudo apt autoremove
sudo apt autoclean
```

2. reboot
   
3. unload nvidia_drm if exist via
```
systemctl isolate multi-user.target
modprobe -r nvidia-drm

# if all process completed but no GUI appear
systemctl start graphical.target
```

4. clone the repo of `https://github.com/tinygrad/open-gpu-kernel-modules/tree/565.57.01-p2p`
5. configure to correct branch via `git branch -a && git switch XXX.XX.XX`. In my case I use `git switch 565.57.01-p2p`
6. run `make modules -j$(nproc)`. If report gcc error, you need to install gcc-12 via
```
sudo apt update
sudo apt install gcc-12 g++-12
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 120 --slave /usr/bin/g++ g++ /usr/bin/g++-12
```

7. run `sudo make modules_install -j$(nproc)`
8. Download the correct verion of linux driver (e.g. `https://www.nvidia.com/en-us/drivers/details/233008/`) and install it via `sh ./NVIDIA-Linux-[...].run --no-kernel-modules`
9. reboot

# Enable/Check Rebar and stop iommu and/or amd_iommu

# Install Cudatoolkit and compile SimpleP2P & P2PLatencyTest to validate the results
